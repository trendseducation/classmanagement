<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4361ee;
            --primary-light: #e6e9ff;
            --secondary-color: #3f37c9;
            --accent-color: #4895ef;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --success-color: #4bb543;
            --error-color: #ff3333;
            --warning-color: #ffcc00;
            --border-radius: 12px;
            --box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f5 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: var(--dark-color);
        }
        
        .container {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 100%;
            max-width: 500px;
            padding: 40px;
            position: relative;
            overflow: hidden;
            transition: var(--transition);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .container:hover {
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.12);
            transform: translateY(-5px);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }
        
        .header h1 {
            color: var(--primary-color);
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
            position: relative;
            display: inline-block;
        }
        
        .header h1::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background: var(--accent-color);
            border-radius: 3px;
        }
        
        .header p {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .form-group {
            margin-bottom: 25px;
            position: relative;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--dark-color);
            font-weight: 500;
            font-size: 14px;
        }
        
        .form-control {
            width: 100%;
            padding: 14px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: var(--transition);
            background-color: #f8f9fa;
            color: var(--dark-color);
        }
        
        .form-control:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
            outline: none;
            background-color: white;
        }
        
        select.form-control {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 15px;
            padding-right: 35px;
        }
        
        .admin-fields, .student-fields, .teacher-fields, .staff-fields {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            width: 100%;
            transition: var(--transition);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 48px;
            box-shadow: 0 4px 6px rgba(67, 97, 238, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }
        
        .btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(67, 97, 238, 0.15);
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(67, 97, 238, 0.1);
        }
        
        .btn-secondary {
            background-color: #6c757d;
            margin-top: 10px;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        .btn-ghost {
            background-color: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }
        
        .btn-ghost:hover {
            background-color: var(--primary-light);
        }
        
        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 2px solid white;
            width: 18px;
            height: 18px;
            display: inline-block;
            animation: spin 1s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .btn .spinner {
            display: none;
        }
        
        .btn.loading .spinner {
            display: inline-block;
        }
        
        .btn.loading span:not(.spinner) {
            display: none;
        }
        
        .message {
            text-align: center;
            margin-top: 20px;
            padding: 12px;
            border-radius: 8px;
            display: none;
            font-size: 14px;
            font-weight: 500;
            border: 1px solid transparent;
        }
        
        .success {
            background-color: rgba(75, 181, 67, 0.15);
            color: var(--success-color);
            display: block;
            border-color: rgba(75, 181, 67, 0.3);
        }
        
        .error {
            background-color: rgba(255, 51, 51, 0.15);
            color: var(--error-color);
            display: block;
            border-color: rgba(255, 51, 51, 0.3);
        }
        
        .warning {
            background-color: rgba(255, 204, 0, 0.15);
            color: var(--warning-color);
            display: block;
            border-color: rgba(255, 204, 0, 0.3);
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(3px);
        }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px);
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            box-shadow: var(--box-shadow);
            position: relative;
            transform: translateY(0);
            transition: var(--transition);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-title {
            font-size: 22px;
            font-weight: 600;
            color: var(--primary-color);
            margin: 0;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
            transition: var(--transition);
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .close-btn:hover {
            background-color: #f0f0f0;
            color: #333;
        }
        
        .modal-body {
            padding: 15px 0;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .form-section {
            border: 1px solid #e0e0e0;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 25px;
            background: #f9f9f9;
            transition: var(--transition);
        }
        
        .form-section:hover {
            border-color: var(--primary-light);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .section-title {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
        }
        
        .section-title i {
            margin-right: 10px;
            font-size: 20px;
        }
        
        .user-select-container {
            position: relative;
        }
        
        .user-select-input {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        #updateUserNameDisplay {
            cursor: pointer;
            background-color: white;
            padding-right: 40px;
        }
        
        .btn-select-user {
            position: absolute;
            right: 5px;
            height: 100%;
            background: transparent;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            color: #666;
            border-radius: 0 8px 8px 0;
            transition: var(--transition);
        }
        
        .btn-select-user:hover {
            background: #f0f0f0;
            color: #333;
        }
        
        .user-list-container {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
        }
        
        .user-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: var(--transition);
            display: flex;
            align-items: center;
        }
        
        .user-item:hover {
            background-color: #f5f5f5;
        }
        
        .user-item:last-child {
            border-bottom: none;
        }
        
        .user-item i {
            margin-right: 10px;
            color: var(--primary-color);
            font-size: 16px;
        }
        
        .no-users {
            padding: 20px;
            text-align: center;
            color: #666;
        }
        
        .user-branch {
            font-size: 12px;
            color: #666;
            margin-left: 5px;
        }
        
        .password-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #666;
            background: none;
            border: none;
            font-size: 16px;
        }
        
        .password-toggle:hover {
            color: #333;
        }
        
        /* Responsive styles */
        @media (max-width: 768px) {
            .container {
                padding: 30px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .btn {
                padding: 12px 20px;
                height: 46px;
            }
            
            .modal-content {
                padding: 25px;
            }
            
            .modal-footer {
                flex-direction: column;
                gap: 10px;
            }
            
            .modal-footer .btn {
                width: 100%;
            }
        }
        
        @media (max-width: 576px) {
            .container {
                padding: 25px 20px;
            }
            
            .header h1 {
                font-size: 22px;
            }
            
            .form-control {
                padding: 12px 15px;
            }
            
            .modal-content {
                padding: 20px;
                width: 95%;
            }
            
            .modal-title {
                font-size: 20px;
            }
            
            .form-section {
                padding: 15px;
            }
        }
        
        /* Animation for modal appearance */
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Floating animation for container */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        
        .container {
            animation: float 6s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Account Portal</h1>
            <p>Manage your account credentials securely</p>
        </div>
        
        <form id="accountForm">
            <div class="form-section">
                <div class="section-title">
                    <i class="fas fa-user-tag"></i>
                    <span>User Information</span>
                </div>
                
                <div class="form-group">
                    <label for="userType"><i class="fas fa-users-cog"></i> Select User Type</label>
                    <select class="form-control" id="userType" required>
                        <option value="" selected disabled>Select User Type</option>
                        <option value="Admin">Admin</option>
                        <option value="Student">Student</option>
                        <option value="Teacher">Teacher</option>
                        <option value="Staff">Staff</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="branch"><i class="fas fa-building"></i> Select Branch</label>
                    <select class="form-control" id="branch" required>
                        <option value="" selected disabled>Select Branch</option>
                        <option value="naka">Naka</option>
                        <option value="kamatghar">Kamatghar</option>
                        <option value="computer kamatghar">Computer Kamatghar</option>
                        <option value="mithpada">Mithpada</option>
                    </select>
                </div>
            </div>
            
            <!-- Admin Fields -->
            <div id="adminFields" class="admin-fields">
                <div class="form-section">
                    <div class="section-title">
                        <i class="fas fa-user-shield"></i>
                        <span>Admin Details</span>
                    </div>
                    
                    <div class="form-group">
                        <label for="adminName"><i class="fas fa-signature"></i> Admin Name</label>
                        <input type="text" class="form-control" id="adminName" placeholder="Enter admin name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="adminPassword"><i class="fas fa-lock"></i> Password</label>
                        <div style="position: relative;">
                            <input type="password" class="form-control" id="adminPassword" placeholder="Enter password" required>
                            <button type="button" class="password-toggle" id="toggleAdminPassword">
                                <i class="far fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn" id="adminSubmitBtn">
                        <span class="spinner" id="adminSubmitSpinner"></span>
                        <span id="adminSubmitText">Create Admin Account</span>
                    </button>
                </div>
            </div>
            
            <!-- Student Fields -->
            <div id="studentFields" class="student-fields">
                <div class="form-section">
                    <div class="section-title">
                        <i class="fas fa-user-graduate"></i>
                        <span>Student Details</span>
                    </div>
                    
                    <div class="form-group">
                        <label for="studentName"><i class="fas fa-user"></i> Student Name</label>
                        <select class="form-control" id="studentName" required>
                            <option value="" selected disabled>Select branch first</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="studentPassword"><i class="fas fa-lock"></i> Password</label>
                        <div style="position: relative;">
                            <input type="password" class="form-control" id="studentPassword" placeholder="Enter password" required>
                            <button type="button" class="password-toggle" id="toggleStudentPassword">
                                <i class="far fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn" id="studentSubmitBtn">
                        <span class="spinner" id="studentSubmitSpinner"></span>
                        <span id="studentSubmitText">Create Student Account</span>
                    </button>
                </div>
            </div>
            
            <!-- Teacher Fields -->
            <div id="teacherFields" class="teacher-fields">
                <div class="form-section">
                    <div class="section-title">
                        <i class="fas fa-chalkboard-teacher"></i>
                        <span>Teacher Details</span>
                    </div>
                    
                    <div class="form-group">
                        <label for="teacherName"><i class="fas fa-user-tie"></i> Teacher Name</label>
                        <select class="form-control" id="teacherName" required>
                            <option value="" selected disabled>Select branch first</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="teacherPassword"><i class="fas fa-lock"></i> Password</label>
                        <div style="position: relative;">
                            <input type="password" class="form-control" id="teacherPassword" placeholder="Enter password" required>
                            <button type="button" class="password-toggle" id="toggleTeacherPassword">
                                <i class="far fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn" id="teacherSubmitBtn">
                        <span class="spinner" id="teacherSubmitSpinner"></span>
                        <span id="teacherSubmitText">Create Teacher Account</span>
                    </button>
                </div>
            </div>
            
            <!-- Staff Fields -->
            <div id="staffFields" class="staff-fields">
                <div class="form-section">
                    <div class="section-title">
                        <i class="fas fa-user-cog"></i>
                        <span>Staff Details</span>
                    </div>
                    
                    <div class="form-group">
                        <label for="staffName"><i class="fas fa-user"></i> Staff Name</label>
                        <select class="form-control" id="staffName" required>
                            <option value="" selected disabled>Select branch first</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="staffPassword"><i class="fas fa-lock"></i> Password</label>
                        <div style="position: relative;">
                            <input type="password" class="form-control" id="staffPassword" placeholder="Enter password" required>
                            <button type="button" class="password-toggle" id="toggleStaffPassword">
                                <i class="far fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn" id="staffSubmitBtn">
                        <span class="spinner" id="staffSubmitSpinner"></span>
                        <span id="staffSubmitText">Create Staff Account</span>
                    </button>
                </div>
            </div>
            
            <div class="form-group" style="display: flex; gap: 15px; margin-top: 20px;">
    <button type="button" class="btn btn-secondary" id="updateBtn" style="flex: 1; background: linear-gradient(135deg, #4361ee 0%, #3f37c9 100%); border: none; box-shadow: 0 4px 8px rgba(67, 97, 238, 0.3);">
        <span class="spinner" id="updateBtnSpinner"></span>
        <span id="updateBtnText"><i class="fas fa-key"></i> Update Password</span>
    </button>
    <button type="button" class="btn btn-secondary" id="LoginAgain" 
        style="flex: 1; background: linear-gradient(135deg, #4bb543 0%, #3a9e32 100%); border: none; box-shadow: 0 4px 8px rgba(75, 181, 67, 0.3);"
        onclick="handleLogout()">
    <span class="spinner" id="updateBtnSpinner"></span>
    <span id="LoginAgainText"><i class="fas fa-sign-in-alt"></i> Go to Login</span>
</button>
</div>
            
            <div class="message" id="message"></div>
        </form>
    </div>

    <!-- Update Password Modal -->
    <div class="modal" id="updateModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-key"></i> Update Password</h3>
                <button class="close-btn" id="closeModal">&times;</button>
            </div>
            
            <form id="updateForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="updateUserType"><i class="fas fa-user-tag"></i> User Type</label>
                        <select class="form-control" id="updateUserType" required>
                            <option value="" selected disabled>Select Type</option>
                            <option value="Admin">Admin</option>
                            <option value="Student">Student</option>
                            <option value="Teacher">Teacher</option>
                            <option value="Staff">Staff</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="updateUserName"><i class="fas fa-user"></i> User Name</label>
                        <div class="user-select-container">
                            <div class="user-select-input" id="updateUserNameContainer">
                                <input type="text" class="form-control" id="updateUserNameDisplay" placeholder="Select Type First" readonly>
                                <input type="hidden" id="updateUserName" required>
                                <button type="button" class="btn-select-user" id="showUserListBtn">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group" id="userBranchInfo">
                        <small id="selectedUserBranch" style="color: #666; font-size: 12px;"></small>
                    </div>
                    
                    <div class="form-group">
                        <label for="newPassword"><i class="fas fa-lock"></i> New Password</label>
                        <div style="position: relative;">
                            <input type="password" class="form-control" id="newPassword" placeholder="Enter new password" required>
                            <button type="button" class="password-toggle" id="toggleNewPassword">
                                <i class="far fa-eye"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelUpdate">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="submit" class="btn" id="confirmUpdateBtn">
                        <span class="spinner" id="updateSpinner"></span>
                        <span id="updateText"><i class="fas fa-save"></i> Update</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- User List Popup Modal -->
    <div class="modal" id="userListModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-users"></i> Select User</h3>
                <button class="close-btn" id="closeUserListModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <input type="text" class="form-control" id="userSearchInput" placeholder="Search users...">
                </div>
                <div class="user-list-container" id="userListContainer">
                    <div class="no-users">Select user type first</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="overlay" id="overlay">
        <div class="loader"></div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const appConfig = {
                spreadsheetId: "10YEaav-QEL19peIzut_fDol52cK1QTsxl449-oI9a74",
                sheetName: "Login_Portal",
                scriptUrl: "https://script.google.com/macros/s/AKfycbzDz1PGYg52o8iCfCE3vonw-tk87Ntgiwqqr23qQMnI2jlKA6GSaxKSGsWKcyrvRjqHZA/exec"
            };
            
            // Data sources for each branch
            const branchDataSources = {
                "naka": {
                    student: {
                        spreadsheetId: "1k7voQwSN-V2JvYtV_iWauCMQjTvculS8rwxtTkNnaUQ",
                        sheetName: "Adm_11Com",
                        column: 3
                    },
                    teacher: {
                        spreadsheetId: "1vA2wS9S05TdOkjiHUZreBfW3mfSJDwqcbQFgAcJ7fI8",
                        sheetName: "Teacher_Details",
                        column: 3
                    },
                    staff: {
                        spreadsheetId: "1vA2wS9S05TdOkjiHUZreBfW3mfSJDwqcbQFgAcJ7fI8",
                        sheetName: "Staff_Details",
                        column: 3
                    }
                },
                "kamatghar": {
                    student: {
                        spreadsheetId: "1rDjeUVYtneVzA6d8-VwyoZ8B8o1MHDxG-vlgN3O2c-1",
                        sheetName: "Computer",
                        column: 2
                    },
                    teacher: {
                        spreadsheetId: "1sM1xjoZ3XoDcNAJjo8c3JUT6T1-dc8lx7MTP_56dCky",
                        sheetName: "Teacher_Details",
                        column: 2
                    },
                    staff: {
                        spreadsheetId: "1sM1xjoZ3XoDcNAljL8c3JUT6T1-dc8lx7MTP_56dCky",
                        sheetName: "Staff_Details",
                        column: 2
                    }
                },
                "computer kamatghar": {
                    student: {
                        spreadsheetId: "1rDjeUVYtneVzA6d8-VwyoZ8B8w1MHDxG-vlgN3O2c-0",
                        sheetName: "Computer",
                        column: 3
                    },
                    teacher: {
                        spreadsheetId: "1sM1xjoZ3XoDcNAJjL8c3JUT6T1-dc8lx7MTP_56dCkw",
                        sheetName: "Teacher_Details",
                        column: 3
                    },
                    staff: {
                        spreadsheetId: "1sM1xjoZ3XoDcNAJjL8c3JUT6T1-dc8lx7MTP_56dCkw",
                        sheetName: "Staff_Details",
                        column: 3
                    }
                },
                "mithpada": {
                    student: {
                        spreadsheetId: "1rDjeUVYtneVzA6d8-VwyoZ8B8w1MHDxG-vlgN3O2c-6",
                        sheetName: "Computer",
                        column: 3
                    },
                    teacher: {
                        spreadsheetId: "1sM1xjoZ3XoDcNAJjL8c3JUT6T1-dc8lx7MTP_56dCkp",
                        sheetName: "Teacher_Details",
                        column: 3
                    },
                    staff: {
                        spreadsheetId: "1sM1xjoZ3XoDcNAJjL8c3JUT6T1-dc8lx7MTP_56dCkp",
                        sheetName: "Staff_Details",
                        column: 3
                    }
                }
            };

            // DOM Elements
            const userTypeSelect = document.getElementById('userType');
            const branchSelect = document.getElementById('branch');
            const adminFields = document.getElementById('adminFields');
            const studentFields = document.getElementById('studentFields');
            const teacherFields = document.getElementById('teacherFields');
            const staffFields = document.getElementById('staffFields');
            const adminSubmitBtn = document.getElementById('adminSubmitBtn');
            const studentSubmitBtn = document.getElementById('studentSubmitBtn');
            const teacherSubmitBtn = document.getElementById('teacherSubmitBtn');
            const staffSubmitBtn = document.getElementById('staffSubmitBtn');
            const accountForm = document.getElementById('accountForm');
            const messageDiv = document.getElementById('message');
            const overlay = document.getElementById('overlay');
            const updateBtn = document.getElementById('updateBtn');
            const updateModal = document.getElementById('updateModal');
            const closeModal = document.getElementById('closeModal');
            const cancelUpdate = document.getElementById('cancelUpdate');
            const updateForm = document.getElementById('updateForm');
            const updateUserType = document.getElementById('updateUserType');
            const updateUserNameContainer = document.getElementById('updateUserNameContainer');
            const updateUserNameDisplay = document.getElementById('updateUserNameDisplay');
            const updateUserName = document.getElementById('updateUserName');
            const confirmUpdateBtn = document.getElementById('confirmUpdateBtn');
            const newPassword = document.getElementById('newPassword');
            const userListModal = document.getElementById('userListModal');
            const closeUserListModal = document.getElementById('closeUserListModal');
            const userSearchInput = document.getElementById('userSearchInput');
            const userListContainer = document.getElementById('userListContainer');
            const selectedUserBranch = document.getElementById('selectedUserBranch');
            
            // Password toggle elements
            const toggleAdminPassword = document.getElementById('toggleAdminPassword');
            const toggleStudentPassword = document.getElementById('toggleStudentPassword');
            const toggleTeacherPassword = document.getElementById('toggleTeacherPassword');
            const toggleStaffPassword = document.getElementById('toggleStaffPassword');
            const toggleNewPassword = document.getElementById('toggleNewPassword');

            let usersList = [];
            let filteredUsers = [];

            // Initialize the application
            function init() {
                setupEventListeners();
                checkSelections();
                setupPasswordToggles();
            }

            // Set up password toggle functionality
            function setupPasswordToggles() {
                setupPasswordToggle(toggleAdminPassword, 'adminPassword');
                setupPasswordToggle(toggleStudentPassword, 'studentPassword');
                setupPasswordToggle(toggleTeacherPassword, 'teacherPassword');
                setupPasswordToggle(toggleStaffPassword, 'staffPassword');
                setupPasswordToggle(toggleNewPassword, 'newPassword');
            }

            function setupPasswordToggle(toggleBtn, inputId) {
                if (!toggleBtn) return;
                
                toggleBtn.addEventListener('click', function() {
                    const input = document.getElementById(inputId);
                    const icon = this.querySelector('i');
                    
                    if (input.type === 'password') {
                        input.type = 'text';
                        icon.classList.remove('fa-eye');
                        icon.classList.add('fa-eye-slash');
                    } else {
                        input.type = 'password';
                        icon.classList.remove('fa-eye-slash');
                        icon.classList.add('fa-eye');
                    }
                });
            }

            // Set up all event listeners
            function setupEventListeners() {
                // Main form listeners
                userTypeSelect.addEventListener('change', checkSelections);
                branchSelect.addEventListener('change', checkSelections);
                
                // Update modal listeners
                updateBtn.addEventListener('click', openUpdateModal);
                closeModal.addEventListener('click', closeUpdateModal);
                cancelUpdate.addEventListener('click', closeUpdateModal);
                updateUserType.addEventListener('change', handleUpdateUserTypeChange);
                updateForm.addEventListener('submit', handleUpdateFormSubmit);
                
                // User selection popup listeners
                updateUserNameContainer.addEventListener('click', openUserListPopup);
                closeUserListModal.addEventListener('click', closeUserListPopup);
                userSearchInput.addEventListener('input', filterUserList);
                
                // Form submission listeners
                if (adminSubmitBtn) adminSubmitBtn.addEventListener('click', handleAdminSubmit);
                if (studentSubmitBtn) studentSubmitBtn.addEventListener('click', handleStudentSubmit);
                if (teacherSubmitBtn) teacherSubmitBtn.addEventListener('click', handleTeacherSubmit);
                if (staffSubmitBtn) staffSubmitBtn.addEventListener('click', handleStaffSubmit);
            }

            // Check selections and show appropriate fields
            function checkSelections() {
                const userType = userTypeSelect.value;
                const branch = branchSelect.value;
                
                if (userType && branch) {
                    if (userType === 'Admin') {
                        showAdminFields();
                    } else if (userType === 'Student') {
                        showStudentFields(branch);
                    } else if (userType === 'Teacher') {
                        showTeacherFields(branch);
                    } else if (userType === 'Staff') {
                        showStaffFields(branch);
                    }
                } else {
                    hideAllFields();
                }
            }

            function showAdminFields() {
                adminFields.style.display = 'block';
                studentFields.style.display = 'none';
                teacherFields.style.display = 'none';
                staffFields.style.display = 'none';
                adminSubmitBtn.style.display = 'block';
                studentSubmitBtn.style.display = 'none';
                teacherSubmitBtn.style.display = 'none';
                staffSubmitBtn.style.display = 'none';
            }

            function showStudentFields(branch) {
                adminFields.style.display = 'none';
                studentFields.style.display = 'block';
                teacherFields.style.display = 'none';
                staffFields.style.display = 'none';
                adminSubmitBtn.style.display = 'none';
                studentSubmitBtn.style.display = 'block';
                teacherSubmitBtn.style.display = 'none';
                staffSubmitBtn.style.display = 'none';
                loadStudentNames(branch);
            }

            function showTeacherFields(branch) {
                adminFields.style.display = 'none';
                studentFields.style.display = 'none';
                teacherFields.style.display = 'block';
                staffFields.style.display = 'none';
                adminSubmitBtn.style.display = 'none';
                studentSubmitBtn.style.display = 'none';
                teacherSubmitBtn.style.display = 'block';
                staffSubmitBtn.style.display = 'none';
                loadTeacherNames(branch);
            }

            function showStaffFields(branch) {
                adminFields.style.display = 'none';
                studentFields.style.display = 'none';
                teacherFields.style.display = 'none';
                staffFields.style.display = 'block';
                adminSubmitBtn.style.display = 'none';
                studentSubmitBtn.style.display = 'none';
                teacherSubmitBtn.style.display = 'none';
                staffSubmitBtn.style.display = 'block';
                loadStaffNames(branch);
            }

            function hideAllFields() {
                adminFields.style.display = 'none';
                studentFields.style.display = 'none';
                teacherFields.style.display = 'none';
                staffFields.style.display = 'none';
                adminSubmitBtn.style.display = 'none';
                studentSubmitBtn.style.display = 'none';
                teacherSubmitBtn.style.display = 'none';
                staffSubmitBtn.style.display = 'none';
            }

            // Load student names from external sheet
            function loadStudentNames(branch) {
                const studentNameSelect = document.getElementById('studentName');
                studentNameSelect.innerHTML = '<option value="" selected disabled>Loading students...</option>';
                studentNameSelect.disabled = true;
                
                const dataSource = branchDataSources[branch]?.student;
                if (!dataSource) {
                    studentNameSelect.innerHTML = '<option value="" selected disabled>No data source for this branch</option>';
                    return;
                }
                
                fetchData('getExternalStudents', dataSource)
                    .then(data => {
                        if (data.status === "success" && data.students?.length > 0) {
                            populateSelect(studentNameSelect, data.students, 'Select Student');
                        } else {
                            studentNameSelect.innerHTML = '<option value="" selected disabled>No students found</option>';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading students:', error);
                        studentNameSelect.innerHTML = '<option value="" selected disabled>Error loading students</option>';
                    });
            }

            // Load teacher names from external sheet
            function loadTeacherNames(branch) {
                const teacherNameSelect = document.getElementById('teacherName');
                teacherNameSelect.innerHTML = '<option value="" selected disabled>Loading teachers...</option>';
                teacherNameSelect.disabled = true;
                
                const dataSource = branchDataSources[branch]?.teacher;
                if (!dataSource) {
                    teacherNameSelect.innerHTML = '<option value="" selected disabled>No data source for this branch</option>';
                    return;
                }
                
                fetchData('getExternalTeachers', dataSource)
                    .then(data => {
                        if (data.status === "success" && data.teachers?.length > 0) {
                            populateSelect(teacherNameSelect, data.teachers, 'Select Teacher');
                        } else {
                            teacherNameSelect.innerHTML = '<option value="" selected disabled>No teachers found</option>';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading teachers:', error);
                        teacherNameSelect.innerHTML = '<option value="" selected disabled>Error loading teachers</option>';
                    });
            }

            // Load staff names from external sheet
            function loadStaffNames(branch) {
                const staffNameSelect = document.getElementById('staffName');
                staffNameSelect.innerHTML = '<option value="" selected disabled>Loading staff...</option>';
                staffNameSelect.disabled = true;
                
                const dataSource = branchDataSources[branch]?.staff;
                if (!dataSource) {
                    staffNameSelect.innerHTML = '<option value="" selected disabled>No data source for this branch</option>';
                    return;
                }
                
                fetchData('getExternalStaff', dataSource)
                    .then(data => {
                        if (data.status === "success" && data.staff?.length > 0) {
                            populateSelect(staffNameSelect, data.staff, 'Select Staff');
                        } else {
                            staffNameSelect.innerHTML = '<option value="" selected disabled>No staff found</option>';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading staff:', error);
                        staffNameSelect.innerHTML = '<option value="" selected disabled>Error loading staff</option>';
                    });
            }

            // Generic function to fetch data
            function fetchData(action, dataSource) {
                const url = `${appConfig.scriptUrl}?action=${action}&spreadsheetId=${encodeURIComponent(dataSource.spreadsheetId)}&sheetName=${encodeURIComponent(dataSource.sheetName)}&column=${dataSource.column}`;
                return fetch(url).then(response => response.json());
            }

            // Populate select element with options
            function populateSelect(selectElement, items, defaultText) {
                selectElement.innerHTML = `<option value="" selected disabled>${defaultText}</option>`;
                
                items.forEach(item => {
                    if (item.name) {
                        const option = document.createElement('option');
                        option.value = item.name;
                        option.textContent = item.name;
                        selectElement.appendChild(option);
                    }
                });
                
                selectElement.disabled = false;
            }

            // Update Password Modal Functions
            function openUpdateModal() {
                showLoading(updateBtn, true);
                overlay.style.display = 'flex';
                
                Promise.all([
                    fetchData('getAdmins', appConfig),
                    fetchData('getStudents', appConfig),
                    fetchData('getTeachers', appConfig),
                    fetchData('getStaff', appConfig)
                ])
                .then(([adminsData, studentsData, teachersData, staffData]) => {
                    usersList = [];
                    
                    if (adminsData.status === "success" && adminsData.admins) {
                        usersList = usersList.concat(adminsData.admins.map(admin => ({
                            ...admin,
                            isStudent: false,
                            isTeacher: false,
                            isStaff: false
                        })));
                    }
                    
                    if (studentsData.status === "success" && studentsData.students) {
                        usersList = usersList.concat(studentsData.students.map(student => ({
                            ...student,
                            isStudent: true,
                            isTeacher: false,
                            isStaff: false
                        })));
                    }
                    
                    if (teachersData.status === "success" && teachersData.teachers) {
                        usersList = usersList.concat(teachersData.teachers.map(teacher => ({
                            ...teacher,
                            isStudent: false,
                            isTeacher: true,
                            isStaff: false
                        })));
                    }

                    if (staffData.status === "success" && staffData.staff) {
                        usersList = usersList.concat(staffData.staff.map(staff => ({
                            ...staff,
                            isStudent: false,
                            isTeacher: false,
                            isStaff: true
                        })));
                    }
                    
                    updateModal.style.display = 'flex';
                    resetUpdateForm();
                })
                .catch(error => {
                    showMessage('Error fetching user data: ' + error.message, 'error');
                })
                .finally(() => {
                    showLoading(updateBtn, false);
                    overlay.style.display = 'none';
                });
            }

            function closeUpdateModal() {
                updateModal.style.display = 'none';
            }

            function resetUpdateForm() {
                updateUserType.value = '';
                updateUserNameDisplay.value = '';
                updateUserName.value = '';
                newPassword.value = '';
                selectedUserBranch.textContent = '';
            }

            function handleUpdateUserTypeChange() {
                updateUserNameDisplay.value = '';
                updateUserName.value = '';
                selectedUserBranch.textContent = '';
                
                if (this.value && usersList.length > 0) {
                    filteredUsers = this.value === 'Admin' 
                        ? usersList.filter(u => !u.isStudent && !u.isTeacher && !u.isStaff && u.name && u.password && u.branch)
                        : this.value === 'Student'
                            ? usersList.filter(u => u.isStudent && u.name && u.password && u.branch)
                            : this.value === 'Teacher'
                                ? usersList.filter(u => u.isTeacher && u.name && u.password && u.branch)
                                : usersList.filter(u => u.isStaff && u.name && u.password && u.branch);
                } else {
                    filteredUsers = [];
                }
            }

            function handleUpdateFormSubmit(e) {
                e.preventDefault();
                
                const userType = updateUserType.value;
                const userName = updateUserName.value;
                const password = newPassword.value;
                
                if (!userType || !userName || !password) {
                    showMessage('Please fill all fields', 'error');
                    return;
                }
                
                showLoading(confirmUpdateBtn, true);
                overlay.style.display = 'flex';
                
                const formData = {
                    action: "updatePassword",
                    config: appConfig,
                    type: userType.toLowerCase(),
                    username: userName,
                    newPassword: password
                };
                
                submitFormData(formData)
                    .then(() => {
                        showMessage('Password updated successfully!', 'success');
                        updateForm.reset();
                        updateModal.style.display = 'none';
                    })
                    .catch(error => {
                        showMessage('Error updating password. Please check your connection and try again.', 'error');
                    })
                    .finally(() => {
                        showLoading(confirmUpdateBtn, false);
                        overlay.style.display = 'none';
                    });
            }

            // User List Popup Functions
            function openUserListPopup() {
                if (!updateUserType.value) {
                    showMessage('Please select user type first', 'error');
                    return;
                }
                
                if (filteredUsers.length === 0) {
                    showMessage('No users found for selected type', 'error');
                    return;
                }
                
                populateUserList(filteredUsers);
                userListModal.style.display = 'flex';
            }

            function closeUserListPopup() {
                userListModal.style.display = 'none';
            }

            function filterUserList() {
                const searchTerm = this.value.toLowerCase();
                const userItems = userListContainer.querySelectorAll('.user-item');
                
                userItems.forEach(item => {
                    const userName = item.textContent.toLowerCase();
                    item.style.display = userName.includes(searchTerm) ? 'block' : 'none';
                });
            }

            function populateUserList(users) {
                userListContainer.innerHTML = '';
                userSearchInput.value = '';
                
                if (users.length === 0) {
                    userListContainer.innerHTML = '<div class="no-users">No users found</div>';
                    return;
                }
                
                users.forEach(user => {
                    const userItem = document.createElement('div');
                    userItem.className = 'user-item';
                    
                    let iconClass = 'fas fa-user';
                    if (user.isStudent) iconClass = 'fas fa-user-graduate';
                    else if (user.isTeacher) iconClass = 'fas fa-chalkboard-teacher';
                    else if (user.isStaff) iconClass = 'fas fa-user-cog';
                    
                    userItem.innerHTML = `
                        <i class="${iconClass}"></i>
                        <span>${user.name}</span>
                        ${user.branch ? `<span class="user-branch">(${user.branch})</span>` : ''}
                    `;
                    
                    userItem.addEventListener('click', () => selectUser(user));
                    userListContainer.appendChild(userItem);
                });
            }

            function selectUser(user) {
                updateUserNameDisplay.value = user.name;
                updateUserName.value = user.name;
                
                if (user.branch) {
                    selectedUserBranch.textContent = `Branch: ${user.branch}`;
                }
                
                userListModal.style.display = 'none';
            }

            // Form Submission Handlers
            function handleAdminSubmit(e) {
                e.preventDefault();
                
                const adminName = document.getElementById('adminName').value;
                const password = document.getElementById('adminPassword').value;
                const branch = document.getElementById('branch').value;
                
                if (!adminName || !password || !branch) {
                    showMessage('Please fill all admin fields', 'error');
                    return;
                }
                
                const formData = {
                    action: "submit",
                    config: appConfig,
                    type: "admin",
                    adminName: adminName,
                    password: password,
                    branch: branch
                };
                
                submitForm(formData, adminSubmitBtn, adminFields);
            }

            function handleStudentSubmit(e) {
                e.preventDefault();
                
                const studentName = document.getElementById('studentName').value;
                const password = document.getElementById('studentPassword').value;
                const branch = document.getElementById('branch').value;
                
                if (!studentName || !password || !branch) {
                    showMessage('Please fill all student fields', 'error');
                    return;
                }
                
                const formData = {
                    action: "submit",
                    config: appConfig,
                    type: "student",
                    studentName: studentName,
                    password: password,
                    branch: branch
                };
                
                submitForm(formData, studentSubmitBtn, studentFields);
            }

            function handleTeacherSubmit(e) {
                e.preventDefault();
                
                const teacherName = document.getElementById('teacherName').value;
                const password = document.getElementById('teacherPassword').value;
                const branch = document.getElementById('branch').value;
                
                if (!teacherName || !password || !branch) {
                    showMessage('Please fill all teacher fields', 'error');
                    return;
                }
                
                const formData = {
                    action: "submit",
                    config: appConfig,
                    type: "teacher",
                    teacherName: teacherName,
                    password: password,
                    branch: branch
                };
                
                submitForm(formData, teacherSubmitBtn, teacherFields);
            }

            function handleStaffSubmit(e) {
                e.preventDefault();
                
                const staffName = document.getElementById('staffName').value;
                const password = document.getElementById('staffPassword').value;
                const branch = document.getElementById('branch').value;
                
                if (!staffName || !password || !branch) {
                    showMessage('Please fill all staff fields', 'error');
                    return;
                }
                
                const formData = {
                    action: "submit",
                    config: appConfig,
                    type: "staff",
                    staffName: staffName,
                    password: password,
                    branch: branch
                };
                
                submitForm(formData, staffSubmitBtn, staffFields);
            }

            // Generic form submission function
            function submitForm(formData, submitButton, fieldsContainer) {
                showLoading(submitButton, true);
                overlay.style.display = 'flex';
                
                submitFormData(formData)
                    .then(() => {
                        showMessage(`${formData.type} data submitted successfully!`, 'success');
                        accountForm.reset();
                        fieldsContainer.style.display = 'none';
                        submitButton.style.display = 'none';
                        userTypeSelect.value = '';
                        branchSelect.value = '';
                    })
                    .catch(error => {
                        showMessage(`Error submitting ${formData.type} data: ${error.message}`, 'error');
                    })
                    .finally(() => {
                        showLoading(submitButton, false);
                        overlay.style.display = 'none';
                    });
            }

            function submitFormData(formData) {
                return fetch(appConfig.scriptUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
            }

            // Utility Functions
            function showLoading(button, isLoading) {
                const spinner = button.querySelector('.spinner');
                const text = button.querySelector('span:not(.spinner)');
                
                if (isLoading) {
                    button.disabled = true;
                    if (spinner) spinner.style.display = 'inline-block';
                    if (text) text.style.display = 'none';
                } else {
                    button.disabled = false;
                    if (spinner) spinner.style.display = 'none';
                    if (text) text.style.display = 'inline';
                }
            }

            function showMessage(message, type) {
                messageDiv.textContent = message;
                messageDiv.className = 'message ' + type;
                messageDiv.style.display = 'block';
                
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 5000);
            }

            // Initialize the application
            init();
        });
		
		// Enhanced logout handler with loading state
function handleLogout() {
    const btn = document.getElementById('LoginAgain');
    const spinner = document.getElementById('updateBtnSpinner');
    const text = document.getElementById('LoginAgainText');
    
    // Show loading state
    btn.disabled = true;
    spinner.style.display = 'inline-block';
    text.innerHTML = '<i class="fas fa-sign-out-alt"></i> Logging out...';
    
    // Set logout flag and clear credentials
    sessionStorage.setItem('justLoggedOut', 'true');
    ['admin', 'student', 'teacher', 'staff'].forEach(role => {
        localStorage.removeItem(`remembered_${role}`);
    });
    
    // Delay redirect to show feedback
    setTimeout(() => {
        window.location.href = "https://trendseducation.github.io/classmanagement/";
    }, 800);
}
    </script>
</body>
</html>
