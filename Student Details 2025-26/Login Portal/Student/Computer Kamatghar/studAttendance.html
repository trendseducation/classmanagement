<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Attendance</title>
	<script src="auth.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f4f4f4;
        }
        .attendancecontainer {
            width: 50%;
            margin: auto;
            background: white;
            padding: 20px;
            box-shadow: 0px 0px 10px gray;
            border-radius: 10px;
            margin-top: 50px;
        }
        .input-container {
            margin-bottom: 20px;
        }
        .popup-spinner {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #fff;
            border-top: 5px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .table-container {
            width: 97%;
            margin-top: 20px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0px 0px 5px gray;
        }
		
		.attendance-summary {
		    width: 100%;
            margin-top: 20px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0px 0px 5px gray;
		}
         /* Ensure the tables maintain their width */
    #tableContainer table {
        width: 100%; /* Adjust as needed */
        table-layout: fixed; /* Ensures consistent column widths */
    }

    #attendanceSummary {
        width: 100%; /* Adjust as needed */
        table-layout: fixed; /* Ensures consistent column widths */
    }

    /* Optional: Add some spacing between tables */
    .table-container, .attendance-summary {
        margin-bottom: 20px;
    }

    /* Hide tables initially */
    #tableContainer, #attendanceSummary {
        display: none;
    }
		 
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: center;
        }
        .attendance-header {
            background-color: #007bff;
            color: white;
        }
        .attendance-totals {
            background-color: #28a745;
            color: white;
        }
        .present {
            background-color: #d4edda;
            color: #155724;
        }
        .absent {
            background-color: #f8d7da;
            color: #721c24;
        }
        #messageContainer {
            margin-top: 20px;
            font-size: 16px;
        }
		
		/* Filter Dropdown */
        .filter-container {
            margin-bottom: 20px;
        }
        select {
            padding: 10px;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid #ccc;
            width: 250px;
        }

        /* MODAL DESIGN */
.monthmodal {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 90%;
    max-width: 350px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    padding: 20px;
    text-align: center;
    z-index: 1000;
}

.monthmodal .modal-content {
    text-align: center;
}

.monthmodal h2 {
    margin-bottom: 10px;
    font-size: 20px;
}

.monthmodal .close {
    position: absolute;
    top: 10px;
    right: 15px;
    font-size: 24px;
    cursor: pointer;
    color: red;
}

/* Month List Styling */
.month-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
}

.month-list button {
            padding: 10px;
            font-size: 16px;
            border: none;
            background: white;
            color: black;
            border-radius: 7px;
            cursor: pointer;
            transition: 0.3s;
			border: 2px solid black; /* Added 2px black border */
}

.month-list button:hover {
    background: #0056b3;
    color: white;
}

        /* BACKDROP */
        .backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 999;
        }
		
		/* Table Styling */
#totalAttendanceTableContainer {
    margin: 20px auto;
    width: 51%;
    text-align: center;
	border-radius: 7px;
}

#totalAttendanceTable {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
    font-size: 16px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

#totalAttendanceTable th, #totalAttendanceTable td {
    padding: 12px;
    border: 1px solid #ddd;
}

#totalAttendanceTable th {
    background-color: #4287f5;
    color: white;
    font-weight: bold;
}

#totalAttendanceTable tr:nth-child(even) {
    background-color: #f9f9f9;
}

#totalAttendanceTable tr:hover {
    background-color: #f1f1f1;
}

/* Style for the total row */
#totalAttendanceTable tbody tr:last-child {
    
    font-weight: bold;
}

#totalAttendanceTable tbody tr:last-child td {
    border-top: 2px solid #0a0a0a; /* Green border at the top */
}

        /* Mobile Responsive Styles */
        @media (max-width: 600px) {
            .container {
                width: 90%;
                padding: 15px;
            }
			.attendancecontainer {
            width: 90%;
            margin: auto;
            background: white;
            padding: 20px;
            box-shadow: 0px 0px 10px gray;
            border-radius: 10px;
            margin-top: 50px;
        }
			.table-container {
            width: 95%;
            margin-top: 20px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0px 0px 5px gray;
        }
		#totalAttendanceTableContainer {
		    width: 92%;
		}
		.input-container input {
            width: 60%;
        }
            h1 {
                font-size: 24px;
            }
            .textbox {
                font-size: 14px;
            }
            .submit-button {
                font-size: 14px;
                padding: 8px 16px;
            }
            th, td {
                padding: 8px;
                font-size: 14px;
            }
            #messageContainer {
                font-size: 14px;
            }
        }

        @media (max-width: 400px) {
            h1 {
                font-size: 20px;
            }
            .textbox {
                font-size: 12px;
            }
            .submit-button {
                font-size: 12px;
                padding: 6px 12px;
            }
            th, td {
                padding: 6px;
                font-size: 12px;
            }
            #messageContainer {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
        <div class="attendancecontainer">
    <h2>Your Attendance</h2>
    <div class="popup-spinner" id="popupSpinner">
        <div class="spinner"></div>
    </div>
	
    <!-- Last 3 Days Attendance Table -->
    <div class="table-container" id="tableContainer">
        <table id="attendanceTable">
            <thead>
                <tr>
                    <th class="attendance-header" colspan="4">Last 3 Days Attendance</th>
                </tr>
                <tr>
                    <th>Student Name</th>
                    <th id="date1">Date 1</th>
                    <th id="date2">Date 2</th>
                    <th id="date3">Date 3</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
	
	<!-- Filter Dropdown -->
    <div class="filter-container" id="filter-containers">
        <select id="attendanceFilter" onchange="applyFilter()">
            <option value="" selected>Filter Attendance</option>
            <option value="thisMonth">This Month Attendance</option>
            <option value="lastMonth">Last Month Attendance</option>
            <option value="monthWise">Month Wise Attendance</option>
            <option value="totalAttendances">Total Attendance</option>
        </select>
    </div>

    <!-- Backdrop -->
    <div id="backdrop" class="backdrop" onclick="closeMonthPopup()"></div>

    <!-- Month Selection Popup -->
    <div id="monthPopup" class="monthmodal">
        <div class="modal-content">
            <span class="close" onclick="closeMonthPopup()">&times;</span>
            <h2>Select a Month</h2>
            <div class="month-list">
                <button onclick="fetchMonthData('June_25')">June</button>
                <button onclick="fetchMonthData('July_25')">July</button>
                <button onclick="fetchMonthData('Aug_25')">August</button>
                <button onclick="fetchMonthData('Sept_25')">September</button>
                <button onclick="fetchMonthData('Oct_25')">October</button>
                <button onclick="fetchMonthData('Nov_25')">November</button>
                <button onclick="fetchMonthData('Dec_25')">December</button>
                <button onclick="fetchMonthData('Jan_26')">January</button>
                <button onclick="fetchMonthData('Feb_26')">February</button>
                <button onclick="fetchMonthData('Mar_26')">March</button>
                <button onclick="fetchMonthData('April_26')">April</button>
            </div>
        </div>
    </div>
	
    <!-- Last 30 Days Attendance Summary -->
    <table class="attendance-summary" id="attendanceSummary">
        <thead>
            <tr>
                <th class="attendance-header" colspan="2" id="summaryHeader">This Month Attendance</th>
            </tr>
            <tr>
                <th class="attendance-totals">Total Present</th>
                <th class="attendance-totals">Total Absent</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td class="present"><span id="totalPresent"></span></td>
                <td class="absent"><span id="totalAbsent"></span></td>
            </tr>
        </tbody>
    </table>
    <div id="messageContainer" class="message"></div>
</div>

<!-- Table for Total Attendance -->
<div class="attendance-summary" id="totalAttendanceTableContainer" style="display: none;">
    <h2>Total Attendance</h2>
    <table id="totalAttendanceTable">
        <thead>
            <tr>
                <th>Month</th>
                <th>Total Present</th>
                <th>Total Absent</th>
            </tr>
        </thead>
        <tbody>
            <!-- Rows will be dynamically added here -->
        </tbody>
    </table>
</div>

    <script>
     const scriptUrl = "https://script.google.com/macros/s/AKfycbz_2JeG9jTS4r2Nz8A5oNStgtGJ7m9OE4fcBiFJljwOasDuBPNXXRmf1eXeRaLxnZez/exec"; // Replace with your Google Script URL
        
		const spreadsheets = [
            { id: "1P14Q5ekW1l2bw76fRNZyR3s1RxD_HxFhfz2s5quVukg", name: "Attendance", label: "11th Commerce" },
            { id: "1lBmzk3Ra42H8WmmygL8rLVJnac39F9y3PRfyqfvdsGs", name: "Attendance", label: "12th Commerce" },
            { id: "18mSTMe9zxozQkQwqzJos0dutzPN-uwVh3RP6XHaQ-Wc", name: "Attendance", label: "11th Science" },
            { id: "1lQzkr2u1s7cHpxMwZOW-ZJLaLPvoP24a5InFap9UidI", name: "Attendance", label: "12th Science" }
        ];

        let currentSpreadsheetId = ""; // To store the spreadsheet ID where the name is found
        let currentSpreadsheetLabel = ""; // To store the spreadsheet label where the name is found
        let sheetName = "Attendance"; // Default sheet name

        // Function to get the student name from the URL query parameter
        function getStudentNameFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('studentName'); // Returns the value of the 'studentName' parameter
        }

        // Automatically search for the student name when the page loads
        window.onload = function () {
            const studentName = getStudentNameFromURL();
            if (studentName) {
                searchName(studentName); // Automatically call searchName with the student name
            } else {
                const messageContainer = document.getElementById("messageContainer");
                messageContainer.innerHTML = "⚠️ No student name provided in the URL";
                messageContainer.style.color = "red";
            }

            // Hide tables initially
            document.getElementById("tableContainer").style.display = "none";
            document.getElementById("attendanceSummary").style.display = "none";
			document.getElementById("filter-containers").style.display = "none";
        };

    function getSheetName() {
        const today = new Date();
        const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();

        if (today.getDate() === lastDayOfMonth) {
            // Switch to the next sheet name explicitly
            if (sheetName === "June_25") {
                return "July_25";
            } else if (sheetName === "July_25") {
                return "Aug_25";
            } else if (sheetName === "Aug_25") {
                return "Sept_25";
            } else if (sheetName === "Sept_25") {
                return "Oct_25";
            } else if (sheetName === "Oct_25") {
                return "Nov_25";
            } else if (sheetName === "Nov_25") {
                return "Dec_25";
            } else if (sheetName === "Dec_25") {
                return "Jan_26";
            } else if (sheetName === "Jan_26") {
                return "Feb_26";
            } else if (sheetName === "Feb_26") {
                return "Mar_26";
            } else if (sheetName === "Mar_26") {
                return "April_26";
            } else {
                return "June_25"; // Default to June_25 if no sheet name matches
            }
        } else {
            return "Attendance"; // Default sheet name
        }
    }

    function isLastDayOfMonth(date) {
        const lastDayOfMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
        return date.getDate() === lastDayOfMonth;
    }

           function searchName(name) {
            let messageContainer = document.getElementById("messageContainer");
            let popupSpinner = document.getElementById("popupSpinner");

            if (!name || name.trim() === "") {
                messageContainer.innerHTML = "⚠️ No student name provided";
                messageContainer.style.color = "red";
                return;
            }

            // Show spinner
            popupSpinner.style.display = "flex";
            messageContainer.innerHTML = "";

            let foundInSheets = [];

         // Function to check a single spreadsheet
            function checkSpreadsheet(spreadsheet, callback) {
                fetch(scriptUrl + "?name=" + encodeURIComponent(name) + "&spreadsheetId=" + encodeURIComponent(spreadsheet.id) + "&sheetName=" + encodeURIComponent(spreadsheet.name))
                    .then(response => response.json())
                    .then(response => {
                        if (response.students && response.students.some(student => student.name.toLowerCase() === name.toLowerCase())) {
                            foundInSheets.push(spreadsheet.label);
                            currentSpreadsheetId = spreadsheet.id; // Store the spreadsheet ID where the name is found
                            currentSpreadsheetLabel = spreadsheet.label; // Store the spreadsheet label where the name is found
                        }
                        callback();
                    })
                    .catch(() => {
                        callback(); // Continue checking other sheets even if one fails
                    });
            }

            // Check all spreadsheets asynchronously
            let remainingChecks = spreadsheets.length;
            spreadsheets.forEach(spreadsheet => {
                checkSpreadsheet(spreadsheet, function () {
                    remainingChecks--;
                    if (remainingChecks === 0) {
                        popupSpinner.style.display = "none"; // Hide spinner

                        if (foundInSheets.length > 0) {
                            messageContainer.innerHTML = `✅ Welcome <strong>${name}</strong> From <strong>${foundInSheets.join(", ")}</strong>`;
                            messageContainer.style.color = "green";

                            // After finding the name, check for the last day of the month in the same spreadsheet
                            if (currentSpreadsheetId && currentSpreadsheetLabel) {
                                checkLastDayOfMonth(currentSpreadsheetId, currentSpreadsheetLabel);
                            }
                        } else {
                            messageContainer.innerHTML = "❌ Name not found in any sheet";
                            messageContainer.style.color = "red";
                        }
                    }
                });
            });
        }

        function checkLastDayOfMonth(spreadsheetId, spreadsheetLabel) {
            const messageContainer = document.getElementById("messageContainer");
            const popupSpinner = document.getElementById("popupSpinner");

            // Show spinner before making the fetch request
            popupSpinner.style.display = "flex";

            fetch(scriptUrl + "?spreadsheetId=" + encodeURIComponent(spreadsheetId) + "&sheetName=Attendance&checkLastDay=true")
                .then(response => response.json())
                .then(response => {
                    if (response.dates) {
                        checkForLastDayOfMonth(response.dates, spreadsheetLabel);
                    } else {
                        const message = document.createElement('div');
                        message.textContent = `No dates found in ${spreadsheetLabel}`;
                        message.style.color = "orange"; // Optional: Add styling to the new message
                        messageContainer.appendChild(message);
                    }
                })
                .catch(() => {
                    console.error("Error checking for the last day of the month");
                })
                .finally(() => {
                    // Hide spinner after the fetch request completes
                    popupSpinner.style.display = "none";
                });
        }

    function checkForLastDayOfMonth(dates, spreadsheetLabel) {
            const messageContainer = document.getElementById('messageContainer');
            messageContainer.innerHTML = '';

            dates.forEach(dateStr => {
                const date = new Date(dateStr);
                if (isLastDayOfMonth(date)) {
                    const message = document.createElement('div');
                    message.innerHTML = `✅ The Attendance of the month till (<strong>${dateStr}</strong>) is done for <strong>${spreadsheetLabel}</strong>`;
                    messageContainer.appendChild(message);

                    // Switch to the next sheet name explicitly
                    if (sheetName === "June_25") {
                        sheetName = "July_25";
                    } else if (sheetName === "July_25") {
                        sheetName = "Aug_25";
                    } else if (sheetName === "Aug_25") {
                        sheetName = "Sept_25";
                    } else if (sheetName === "Sept_25") {
                        sheetName = "Oct_25";
                    } else if (sheetName === "Oct_25") {
                        sheetName = "Nov_25";
                    } else if (sheetName === "Nov_25") {
                        sheetName = "Dec_25";
                    } else if (sheetName === "Dec_25") {
                        sheetName = "Jan_26";
                    } else if (sheetName === "Jan_26") {
                        sheetName = "Feb_26";
                    } else if (sheetName === "Feb_26") {
                        sheetName = "Mar_26";
                    } else if (sheetName === "Mar_26") {
                        sheetName = "April_26";
                    } else {
                        sheetName = "June_25"; // Default to June_25 if no sheet name matches
                    }

                    updateSummaryHeader();
                    fetchData(); // Refetch data with the new sheet name
                }
            });
        }

        function updateSummaryHeader() {
            const summaryHeader = document.getElementById('summaryHeader');
            if (sheetName === "June_25") {
                summaryHeader.textContent = "This June Attendance";
            } else if (sheetName === "July_25") {
                summaryHeader.textContent = "This July Attendance";
            } else if (sheetName === "Aug_25") {
                summaryHeader.textContent = "This August Attendance";
            } else if (sheetName === "Sept_25") {
                summaryHeader.textContent = "This September Attendance";
            } else if (sheetName === "Oct_25") {
                summaryHeader.textContent = "This October Attendance";
            } else if (sheetName === "Nov_25") {
                summaryHeader.textContent = "This November Attendance";
            } else if (sheetName === "Dec_25") {
                summaryHeader.textContent = "This December Attendance";
            } else if (sheetName === "Jan_26") {
                summaryHeader.textContent = "This January Attendance";
            } else if (sheetName === "Feb_26") {
                summaryHeader.textContent = "This February Attendance";
            } else if (sheetName === "Mar_26") {
                summaryHeader.textContent = "This March Attendance";
            } else if (sheetName === "April_26") {
                summaryHeader.textContent = "This April Attendance";
            } else {
                summaryHeader.textContent = "This Attendance";
            }
        }

        function fetchData() {
            const popupSpinner = document.getElementById('popupSpinner');
            popupSpinner.style.display = 'flex';

            const url = `${scriptUrl}?spreadsheetId=${encodeURIComponent(currentSpreadsheetId)}&sheetName=${encodeURIComponent(sheetName)}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    popupSpinner.style.display = 'none';
                    checkForLastDayOfMonth(data.dates, currentSpreadsheetLabel);

                    // Render attendance table and summary for the specific student
                    const studentName = getStudentNameFromURL();
                    const studentData = data.students.find(student => student.name.toLowerCase() === studentName.toLowerCase());
                    if (studentData) {
                        renderAttendanceTable(studentData, data.dates);
                        renderSummary(studentData);
                    }
					// Show tables after the last day of the month is found and sheet name is switched
                    document.getElementById("tableContainer").style.display = "table";
                    document.getElementById("attendanceSummary").style.display = "table";
					document.getElementById("filter-containers").style.display = "table";
                })
                .catch(error => {
                    popupSpinner.style.display = 'none';
                    console.error('Error:', error);
                });
        }

       function renderAttendanceTable(student, dates) {
    const tableBody = document.getElementById('tableBody');
    const date1Header = document.getElementById('date1');
    const date2Header = document.getElementById('date2');
    const date3Header = document.getElementById('date3');

    // Clear table body
    tableBody.innerHTML = '';

    // Determine which dates are available
    const availableDates = [];
    const availableAttendance = [];

    if (dates.length >= 1 && student.attendance[student.attendance.length - 1]) {
        availableDates.push(dates[dates.length - 1]);
        availableAttendance.push(student.attendance[student.attendance.length - 1]);
    }
    if (dates.length >= 2 && student.attendance[student.attendance.length - 2]) {
        availableDates.unshift(dates[dates.length - 2]);
        availableAttendance.unshift(student.attendance[student.attendance.length - 2]);
    }
    if (dates.length >= 3 && student.attendance[student.attendance.length - 3]) {
        availableDates.unshift(dates[dates.length - 3]);
        availableAttendance.unshift(student.attendance[student.attendance.length - 3]);
    }

    // Set date headers and hide/show columns based on availability
    date1Header.textContent = availableDates[0] || "";
    date2Header.textContent = availableDates[1] || "";
    date3Header.textContent = availableDates[2] || "";

    date1Header.style.display = availableDates[0] ? "table-cell" : "none";
    date2Header.style.display = availableDates[1] ? "table-cell" : "none";
    date3Header.style.display = availableDates[2] ? "table-cell" : "none";

    // Render student data
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>${student.name}</td>
        <td>${availableAttendance[0] || ""}</td>
        <td>${availableAttendance[1] || ""}</td>
        <td>${availableAttendance[2] || ""}</td>
    `;
    tableBody.appendChild(row);
}

        function renderSummary(student) {
            document.getElementById('totalPresent').textContent = student.present;
            document.getElementById('totalAbsent').textContent = student.absent;
        }
		
		 // Show the month selection popup
        function applyFilter() {
            var filter = document.getElementById("attendanceFilter").value;
            if (filter === "monthWise") {
                document.getElementById("monthPopup").style.display = "block";
                document.getElementById("backdrop").style.display = "block";
            }
        }

        // Close the month popup
        function closeMonthPopup() {
            document.getElementById("monthPopup").style.display = "none";
            document.getElementById("backdrop").style.display = "none";
        }

        // Fetch data for the selected month and close the popup
        function fetchMonthData(month) {
            console.log("Fetching data for: " + month);
            closeMonthPopup();
        }
		
		// DOM Elements
const attendanceFilter = document.getElementById("attendanceFilter");
const monthPopup = document.getElementById("monthPopup");
const backdrop = document.getElementById("backdrop");
const popupSpinner = document.getElementById("popupSpinner");
const messageContainer = document.getElementById("messageContainer");

// Event Listeners
document.addEventListener("DOMContentLoaded", function () {
    // Hide popup on page load
    monthPopup.style.display = "none";
    backdrop.style.display = "none";

    // Filter dropdown change event
    attendanceFilter.addEventListener("change", function () {
        const filter = this.value;
        if (filter === "monthWise") {
            openMonthPopup();
        } else {
            applyFilter(filter);
        }
    });
});

// Functions

/**
 * Opens the month selection popup.
 */
function openMonthPopup() {
    monthPopup.style.display = "block";
    backdrop.style.display = "block";

    // Enable all buttons when popup opens
    document.querySelectorAll(".month-list button").forEach(button => {
        button.disabled = false;
    });
}

/**
 * Closes the month selection popup.
 */
function closeMonthPopup() {
    monthPopup.style.display = "none";
    backdrop.style.display = "none";
}

/**
 * Shows a message popup with the given message.
 * @param {string} message - The message to display.
 */
function showMessagePopup(message) {
    const messagePopup = document.getElementById("messagePopup");
    const messageText = document.getElementById("messageText");

    messageText.textContent = message; // Set the message text
    messagePopup.style.display = "flex"; // Show the popup
}

/**
 * Closes the message popup.
 */
function closeMessagePopup() {
    const messagePopup = document.getElementById("messagePopup");
    messagePopup.style.display = "none"; // Hide the popup
}

/**
 * Fetches data for the selected month.
 * @param {string} month - The name of the month (e.g., "June_25").
 */
function fetchMonthData(month) {
    closeMonthPopup(); // Close the month selection popup
    popupSpinner.style.display = "flex"; // Show spinner

    // Use the current spreadsheet ID
    const url = `${scriptUrl}?spreadsheetId=${encodeURIComponent(currentSpreadsheetId)}&sheetName=${encodeURIComponent(month)}`;

    fetch(url)
        .then(response => response.json())
        .then(data => {
            popupSpinner.style.display = "none"; // Hide spinner
            if (data.students && data.students.length > 0) {
                renderSummary(data.students[0]); // Render summary for the first student
                updateSummaryHeader2(month); // Update the header for the selected month
            } else {
                showMessagePopup("The Attendance was not available."); // Show message if no data is available
            }
        })
        .catch(error => {
            popupSpinner.style.display = "none"; // Hide spinner
            console.error("Error:", error);
            showMessagePopup("The Attendance was not available."); // Show message on error
        });
}

/**
 * Applies the selected filter.
 * @param {string} filter - The selected filter value.
 */
function applyFilter(filter) {
    const popupSpinner = document.getElementById("popupSpinner");
    const messageContainer = document.getElementById("messageContainer");
    const totalAttendanceTableContainer = document.getElementById("totalAttendanceTableContainer");
    const attendanceSummary = document.getElementById("attendanceSummary");

 if (filter === "totalAttendances") {
        // Hide attendanceSummary when Total Attendance is selected
        attendanceSummary.style.display = "none";
        // Show the total attendance table container
        totalAttendanceTableContainer.style.display = "block";
        // Fetch total attendance for the student
        fetchTotalAttendance();
    } else {
        // Show attendanceSummary when Total Attendance is deselected
        attendanceSummary.style.display = "table";
        // Hide the total attendance table container
        totalAttendanceTableContainer.style.display = "none";

        if (filter === "lastMonth") {
            fetchLastMonthData();
        } else if (filter === "monthWise") {
            // Open the month selection popup
            openMonthPopup();
        } else if (filter === "thisMonth") {
            // Fetch data for the current month
            fetchMonthData(sheetName);
        } else {
            console.log("Applying filter:", filter); // Handle other filters (if any)
        }
    }
}

/**
 * Fetches total attendance for a student.
 */
async function fetchTotalAttendance() {
    const studentName = getStudentNameFromURL(); // Get student name from URL
    const popupSpinner = document.getElementById("popupSpinner");
    const totalAttendanceTableContainer = document.getElementById("totalAttendanceTableContainer");
    const totalAttendanceTableBody = document.querySelector("#totalAttendanceTable tbody");

    if (!studentName) {
        alert("Please enter a student name.");
        return;
    }

    // Show spinner
    popupSpinner.style.display = "flex";

    // Clear the table body
    totalAttendanceTableBody.innerHTML = "";

    // Array of all spreadsheet names and their corresponding months (already in correct order)
    const months = [
        { name: "June_25", month: "June" },
        { name: "July_25", month: "July" },
        { name: "Aug_25", month: "August" },
        { name: "Sept_25", month: "September" },
        { name: "Oct_25", month: "October" },
        { name: "Nov_25", month: "November" },
        { name: "Dec_25", month: "December" },
        { name: "Jan_26", month: "January" },
        { name: "Feb_26", month: "February" },
        { name: "Mar_26", month: "March" },
        { name: "April_26", month: "April" }
    ];

    // Variables to store totals
    let totalPresent = 0;
    let totalAbsent = 0;
    let hasData = false; // Flag to check if any data is fetched

    // Array to store fetched data temporarily
    const fetchedData = [];

    try {
        // Fetch data for each spreadsheet
        const fetchPromises = months.map(async (sheet) => {
            const url = `${scriptUrl}?spreadsheetId=${encodeURIComponent(currentSpreadsheetId)}&sheetName=${encodeURIComponent(sheet.name)}`;

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Failed to fetch data for ${sheet.month}`);
                }
                const data = await response.json();
                if (data.students && data.students.length > 0) {
                    const student = data.students.find(s => s.name.toLowerCase() === studentName.toLowerCase());
                    if (student) {
                        hasData = true; // Data is available
                        // Store fetched data temporarily
                        fetchedData.push({
                            month: sheet.month,
                            present: student.present || 0,
                            absent: student.absent || 0
                        });

                        // Update totals
                        totalPresent += student.present || 0;
                        totalAbsent += student.absent || 0;
                    }
                }
            } catch (error) {
                console.error(`Error fetching data for ${sheet.month}:`, error);
            }
        });

        // Wait for all fetch requests to complete
        await Promise.all(fetchPromises);

        // Sort fetched data by the order of the `months` array
        const sortedData = months.map(sheet => {
            return fetchedData.find(data => data.month === sheet.month);
        }).filter(data => data); // Remove undefined entries (if any)

        // Append sorted data to the table
        sortedData.forEach(data => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${data.month}</td>
                <td>${data.present}</td>
                <td>${data.absent}</td>
            `;
            totalAttendanceTableBody.appendChild(row);
        });

    } catch (error) {
        console.error("Error in fetchTotalAttendance:", error);
        alert("An error occurred while fetching attendance data.");
    } finally {
        // Hide spinner when all requests are completed
        popupSpinner.style.display = "none";

        if (hasData) {
            // Add the total row at the bottom of the table
            const totalRow = document.createElement("tr");
            totalRow.innerHTML = `
                <td><strong>Total Attendance</strong></td>
                <td><strong>${totalPresent}</strong></td>
                <td><strong>${totalAbsent}</strong></td>
            `;
            totalAttendanceTableBody.appendChild(totalRow);

            // Show the table container
            totalAttendanceTableContainer.style.display = "block";
        } else {
            // Show message popup if no data is available
            showMessagePopup("Attendance was not recorded.");
        }
    }
}
/**
 * Fetches data for the last month.
 */
function fetchLastMonthData() {
    const popupSpinner = document.getElementById("popupSpinner");
    const messageContainer = document.getElementById("messageContainer");

    // Determine the last month's sheet name based on the current sheet name
    const lastMonthSheetName = getLastMonthSheetName();
    if (!lastMonthSheetName) {
        messageContainer.textContent = "There is no previous Attendance submitted.";
        return;
    }

    popupSpinner.style.display = "flex"; // Show spinner

    // Fetch data for the last month's sheet
    const url = `${scriptUrl}?spreadsheetId=${encodeURIComponent(currentSpreadsheetId)}&sheetName=${encodeURIComponent(lastMonthSheetName)}`;

    fetch(url)
        .then(response => response.json())
        .then(data => {
            popupSpinner.style.display = "none"; // Hide spinner
            if (data.students && data.students.length > 0) {
                renderSummary(data.students[0]); // Render summary for the first student
                updateSummaryHeader2(lastMonthSheetName); // Update the header for the last month's data
            } else {
                showMessagePopup("The Attendance was not available."); // Show message if no data is available
            }
        })
        .catch(error => {
            popupSpinner.style.display = "none"; // Hide spinner
            console.error("Error:", error);
            showMessagePopup("The Attendance was not available."); // Show message on error
        });
}

/**
 * Gets the last month's sheet name based on the current sheet name.
 * @returns {string} - The last month's sheet name.
 */
function getLastMonthSheetName() {
    const sheetMap = {
        "July_25": "June_25",
        "Aug_25": "July_25",
        "Sept_25": "Aug_25",
        "Oct_25": "Sept_25",
        "Nov_25": "Oct_25",
        "Dec_25": "Nov_25",
        "Jan_26": "Dec_25",
        "Feb_26": "Jan_26",
        "Mar_26": "Feb_26",
        "April_26": "Mar_26",
        "June_25": null // No previous month for June
    };

    return sheetMap[sheetName] || null;
}

/**
 * Updates the summary header for the selected month.
 * @param {string} sheetName - The name of the sheet.
 */
function updateSummaryHeader2(sheetName) {
    const summaryHeader = document.getElementById("summaryHeader");
    const monthMap = {
        "June_25": "June Attendance",
        "July_25": "July Attendance",
        "Aug_25": "August Attendance",
        "Sept_25": "September Attendance",
        "Oct_25": "October Attendance",
        "Nov_25": "November Attendance",
        "Dec_25": "December Attendance",
        "Jan_26": "January Attendance",
        "Feb_26": "February Attendance",
        "Mar_26": "March Attendance",
        "April_26": "April Attendance"
    };

    summaryHeader.textContent = `This ${monthMap[sheetName] || "Attendance"}`;
}
    </script>
</body>
</html>