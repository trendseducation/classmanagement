<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Payment</title>
	<script src="auth.js"> </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f9f9f9;
            color: #333;
        }
        h2 {
            text-align: center;
            padding: 20px;
            background-color: #6200ea;
            color: white;
            margin: 0;
            box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);
        }
        .tabs {
            display: flex;
            justify-content: space-around;
            background-color: #6200ea;
            padding: 10px 0;
        }
        .tab {
            flex: 1;
            padding: 12px;
            color: white;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.3s ease;
        }
        .tab:hover, .tab.active {
            background-color: #3700b3;
        }
        .tab-content {
            display: none;
            padding: 20px;
			width: 100%;
            padding: 10px;
            border: 1px solid #cccccc;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }
        .tab-content.active {
            display: block;
			
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px auto;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
            word-wrap: break-word;
        }
        th {
            background-color: #f4f4f4;
            font-weight: bold;
        }
        button {
            padding: 10px 20px;
            background-color: #6200ea;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #3700b3;
        }
        input, button {
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        .loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        flex-direction: column;
        color: white;
        font-family: Arial, sans-serif;
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 6px solid transparent;
        border-top: 6px solid #6200ea;
        border-right: 6px solid #03dac6;
        border-bottom: 6px solid #ff0266;
        border-left: 6px solid #ffab00;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        position: relative;
    }

    .percentage {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 14px;
        font-weight: bold;
    }

    @keyframes spin {
        from {
            transform: rotate(0deg);
        }
        to {
            transform: rotate(360deg);
        }
    }
		.form-container {
            background-color: #ffffff;
            padding: 20px 30px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 100%;
        }
		.page2 {
			font-weight: bold;
		}

        .form-container h2 {
            margin-bottom: 20px;
            font-size: 24px;
            color: #333333;
            text-align: center;
        }
		.page3 {
		    font-family: Arial, sans-serif;
		    display: flex;
		    justify-content: center;
            align-items: center;
			padding: 10px;
		}

        .form-group {
            margin-bottom: 15px;
        }

        .tab-content label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #555555;
        }

        .tab-content input {
            width: 100%;
            padding: 10px;
            border: 1px solid #cccccc;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }

        .tab-content input:focus {
            border-color: #007BFF;
            outline: none;
        }

        .submit-btn {
            width: 100%;
            padding: 10px 15px;
            background-color: #007BFF;
            color: #ffffff;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .submit-btn:hover {
            background-color: #0056b3;
        }
		
		.button-group {
            display: flex;
            justify-content: space-between;
            gap: 15px;
        }

        .editbtn, .deletebtn {
		    display: flex;
            justify-content: center;
            align-items: center;
            flex: 1;
            padding: 10px 15px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .editbtn {
            background-color: #007BFF;
            color: #ffffff;
            border: none;
        }

        .editbtn:hover {
            background-color: #0056b3;
        }

        .deletebtn {
            background-color: #d9534f;
            color: #ffffff;
            border: none;
        }

        .deletebtn:hover {
            background-color: #c9302c;
        }
		<!... search Bar >
		
		.search-bar-container {
              display: flex;
              justify-content: center;
              align-items: center;
              margin: 10px 0;
              width: 100%;
    }

    .search-bars {
        width: 90%;
        max-width: 100%;
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s ease;
        box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);
    }

    .search-bar:focus {
        border-color: #6200ea;
        outline: none;
        box-shadow: 0px 4px 6px rgba(98, 0, 234, 0.2);
    }
		
        @media (max-width: 768px) {
            table {
                font-size: 14px;
                margin: 10px;
            }
            .tabs {
                text-align: center;
            }
            .tab {
                padding: 10px;
            }
			.search-bar {
            width: 90%;
            font-size: 14px;
        }
        }
    </style>
</head>
<body>
    <h2>Teacher Payment Details</h2>
    <div class="tabs">
        <div class="tab active" data-tab="tableView">Payment List</div>
        <div class="tab" data-tab="detailsView">Payment Details</div>
        <div class="tab" data-tab="editView">Edit Details</div>
    </div>

        <div class="loading" id="loading" style="display: none;">
        <div class="spinner">
        <div class="percentage" id="loadingPercentage">0%</div>
            </div>
              </div>
			  
    <div style= "display: flex; justify-content: center; align-items: center;">
    <input
        type="text"
        id="searchInput"
        class="search-bars"
        placeholder="Search in Name"
        oninput="searchTable()"
    />
</div>

    <!-- Data Table View (Page 1) -->
    <div id="tableView" class="tab-content active">
        <table id="dataTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Teacher Name</th>
                    <th>Date of Payment</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Details View (Page 2) -->
    <div id="detailsView" class="tab-content">
	<div class="page3">
        <table>
            <tr>
                <td class="page2">ID</td>
                <td id="detailsId"></td>
            </tr>
			<tr>
               <td class="page2">Academic Year</td>
                <td id="detailsAcademic"></td>
            </tr>
			<tr>
               <td class="page2">Date of Payment</td>
                <td id="detailsDOP"></td>
            </tr>
            <tr>
               <td class="page2">Teacher Name</td>
                <td id="detailsName"></td>
            </tr>
			<tr>
               <td class="page2">Stream</td>
                <td id="detailsStream"></td>
            </tr>
            <tr>
             <td class="page2">Total Lecture</td>
             <td id="detailsTlecture"></td>
            </tr>
			<tr>
             <td class="page2">Total Paid Lecture</td>
             <td id="detailsTPlecture"></td>
              </tr>
			  <tr>
               <td class="page2">Total Per Lecture Amount</td>
               <td id="detailsTPlecAmt"></td>
               </tr>
			   <tr>
               <td class="page2">Total Paid Amount</td>
               <td id="detailsTPaidamt"></td>
               </tr>
			   <tr>
               <td class="page2">Balance Amount</td>
               <td id="detailsTotalBal"></td>
               </tr>
			   <tr>
               <td class="page2">Total Payment</td>
               <td id="detailsTotalpayment"></td>
               </tr>
			   <tr>
               <td class="page2">Note</td>
               <td id="detailsNote"></td>
               </tr>
        </table></div>
        <div class="action-buttons">
		<div class="button-group">
            <button id="editButton" class="editbtn">Edit</button>
            <button id="deleteButton" class="deletebtn">Delete</button>
        </div></div>
    </div>

    <!-- Edit View (Page 3) -->
    <div id="editView" class="tab-content">
	<div class="page3">
	<div class="form-container">
        <form id="editForm" oninput="calculateValues()">
		     <label for="editDOP">Date of Payment<span style="color: red;"> *</span></label>
             <input type="date" id="editDOP" required>
            <label for="editName">Teacher Name<span style="color: red;"> *</span></label>
            <input type="text" id="editName" required>
            <label for="editEmail">Stream<span style="color: red;"> *</span></label>
            <input type="text" id="editStream" required>
            <label for="editTlecture">Total Lecture<span style="color: red;"> *</span></label>
                   <input 
                      type="number" 
                       id="editTlecture" 
                       placeholder="Enter total lectures (e.g., 50)" 
                       min="1" 
                       required>
					   <label for="editTPaidLec">Total Paid Lecture<span style="color: red;"> *</span></label>
                    <input 
                       type="number" 
                       id="editTPaidLec" 
                       placeholder="Enter total Paid lectures (e.g., 30)" 
                       min="1" 
                       required>
					   <label for="editPerLecAmt">Per Lecture Amount (₹)<span style="color: red;"> *</span></label>
                    <input 
                       type="number" 
                       id="editPerLecAmt" 
                       placeholder="Enter total Paid lectures (e.g., ₹200)" 
                       min="1" 
                       required>
					   <label for="totalPaid">Total Paid</label>
                       <input type="number" id="totalPaid" readonly style="background-color: #ebe6e6">
					   <label for="balanceAmount">Balance Amount</label>
                       <input type="number" id="balanceAmount" readonly style="background-color: #ebe6e6">
					   <label for="totalPayment">Total Payment</label>
                       <input type="number" id="totalPayment" readonly style="background-color: #ebe6e6">
					   <label for="editNote">Note</label>
                       <input type="text" id="editNote">
            <button type="submit" class="submit-btn">Update</button>
        </form>
    </div></div></div>

    <script>
        const scriptURL = "https://script.google.com/macros/s/AKfycbwumXq8sEncbIXYEMNkaXtK10_a-hfTw7-Vw4hU5Ew5slwktnvrlsiu-fNSGv6AIp6G/exec";

        // Tab switching logic
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });

        const loadingOverlay = document.getElementById("loading");
        let selectedRowData = null;

        async function fetchData() {
            showLoading();
            try {
                const response = await fetch(`${scriptURL}?action=fetchData`);
                const result = await response.json();
                if (result.success) {
                    renderTable(result.data);
                } else {
                    alert(result.message);
                }
            } catch (error) {
                alert("Error fetching data: " + error.message);
            }
            hideLoading();
        }

        function renderTable(data) {
    const tableBody = document.querySelector("#dataTable tbody");
    tableBody.innerHTML = ""; // Clear the table body before rendering new rows

    data.slice(1).forEach((rowData, rowIndex) => {
        const tableRow = document.createElement("tr");
        tableRow.dataset.rowIndex = rowIndex + 2;

        // Extract and format the date
        let formattedDate = '';
        const rawDate = rowData[1];
        const dateObject = new Date(rawDate);
        if (!isNaN(dateObject.getTime())) {
            // Format date as DD-MM-YYYY
            const day = String(dateObject.getDate()).padStart(2, '0');
            const month = String(dateObject.getMonth() + 1).padStart(2, '0');
            const year = dateObject.getFullYear();
            formattedDate = `${day}-${month}-${year}`;
        } else {
            console.error("Invalid date:", rawDate);
            formattedDate = "Invalid Date"; // Fallback text for invalid dates
        }

        // Set row innerHTML
        tableRow.innerHTML = `
            <td>${rowIndex + 1}</td>
			<td>${rowData[2] || ''}</td>
            <td>${formattedDate}</td>
            <td>
                <button onclick="viewDetails(${rowIndex + 2})">View Details</button>
            </td>
        `;
        tableBody.appendChild(tableRow);
    });
}

        function viewDetails(rowIndex) {
            showTab('detailsView');
            selectedRowData = rowIndex;
            loadDetails(selectedRowData);
        }

        async function loadDetails(rowIndex) {
            showLoading();
            try {
                const response = await fetch(`${scriptURL}?action=fetchData`);
                const result = await response.json();
                const rowData = result.data[rowIndex - 1];
                document.getElementById("detailsId").textContent = rowIndex - 1;
				document.getElementById("detailsAcademic").textContent = rowData[0];
                
				(() => {
    const rawDates_DOP = rowData[1]; // Extract raw date from rowData[1]
    const detailsDOPElement = document.getElementById("detailsDOP");

    // Check if the raw date exists and is not empty
    if (rawDates_DOP && rawDates_DOP.trim() !== "") {
        const dateObjects_DOP = new Date(rawDates_DOP);

        // Check if the date is valid
        if (!isNaN(dateObjects_DOP.getTime())) {
            // Get local date parts (e.g., day, month, year)
            const day = String(dateObjects_DOP.getDate()).padStart(2, '0');
            const month = String(dateObjects_DOP.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
            const year = dateObjects_DOP.getFullYear();

            const formattedDates_DOP = `${day}-${month}-${year}`; // Format as DD-MM-YYYY
            detailsDOPElement.textContent = formattedDates_DOP; // Set the formatted date
            detailsDOPElement.closest('tr').style.display = ""; // Show the row
        } else {
            // Handle invalid dates
            detailsDOPElement.textContent = ""; // Clear content
            detailsDOPElement.closest('tr').style.display = "none"; // Hide the row
        }
    } else {
        // Handle empty or missing date values
        detailsDOPElement.textContent = ""; // Clear content
        detailsDOPElement.closest('tr').style.display = "none"; // Hide the row
    }
})();	
				
				document.getElementById("detailsName").textContent = rowData[2];
                document.getElementById("detailsStream").textContent = rowData[3] || '';
                document.getElementById("detailsTlecture").textContent = rowData[4] || '';
                document.getElementById("detailsTPlecture").textContent = rowData[5] || '';
				document.getElementById("detailsTPlecAmt").textContent = rowData[6];
				document.getElementById("detailsTPaidamt").textContent = rowData[7];
				document.getElementById("detailsTotalBal").textContent = rowData[8];
				document.getElementById("detailsTotalpayment").textContent = rowData[9];
				document.getElementById("detailsNote").textContent = rowData[10];
            } catch (error) {
                alert("Error loading details: " + error.message);
            }
            hideLoading();
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tabContent => tabContent.classList.remove('active'));
            document.querySelector(`.tab[data-tab=${tabId}]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }

        // Edit and Delete logic for Page 2
        document.getElementById("editButton").addEventListener('click', () => {
            showTab('editView');
            loadEditForm(selectedRowData);
        });

        document.getElementById("deleteButton").addEventListener('click', async () => {
            const confirmDelete = confirm("Are you sure you want to delete this data?");
            if (confirmDelete) {
                showLoading();
                try {
                    const response = await fetch(`${scriptURL}?action=deleteRow&row=${selectedRowData}`);
                    const result = await response.json();
                    alert(result.message);
                    fetchData();
                    showTab('tableView');
                } catch (error) {
                    alert("Error deleting row: " + error.message);
                }
                hideLoading();
            }
        });

        function loadEditForm(rowIndex) {
            showLoading();
            fetch(`${scriptURL}?action=fetchData`)
                .then(response => response.json())
                .then(result => {
                    const rowData = result.data[rowIndex - 1];
                    const rawDate = rowData[1];
				    const dateObject = new Date(rawDate);
					dateObject.setDate(dateObject.getDate() + 1);
				    const formattedDate = dateObject.toISOString().split("T")[0];
				    document.getElementById("editDOP").value = formattedDate;
                    document.getElementById("editName").value = rowData[2] || '';
                    document.getElementById("editStream").value = rowData[3] || '';
					document.getElementById("editTlecture").value = rowData[4] || '';
					document.getElementById("editTPaidLec").value = rowData[5] || '';
					document.getElementById("editPerLecAmt").value = rowData[6] || '';
					document.getElementById("totalPaid").value = rowData[7] || '';
					document.getElementById("balanceAmount").value = rowData[8] || '';
					document.getElementById("totalPayment").value = rowData[9] || '';
					document.getElementById("editNote").value = rowData[10] || '';
                })
                .catch(error => alert("Error loading edit form: " + error.message))
                .finally(() => hideLoading());
        }

        document.getElementById("editForm").addEventListener('submit', async (e) => {
            e.preventDefault();
            const updatedData = {
			    dop: document.getElementById("editDOP").value,
                name: document.getElementById("editName").value,
                stream: document.getElementById("editStream").value,
                tlecture: document.getElementById("editTlecture").value,
				tpaidlec: document.getElementById("editTPaidLec").value,
				perlecamt: document.getElementById("editPerLecAmt").value,
				totalpaid: document.getElementById("totalPaid").value,
				balanceamount: document.getElementById("balanceAmount").value,
				totalpayment: document.getElementById("totalPayment").value,
				note: document.getElementById("editNote").value
            };
            const updates = [
			    { row: selectedRowData, col: 2, value: updatedData.dop },
                { row: selectedRowData, col: 3, value: updatedData.name },
                { row: selectedRowData, col: 4, value: updatedData.stream },
                { row: selectedRowData, col: 5, value: updatedData.tlecture },
				{ row: selectedRowData, col: 6, value: updatedData.tpaidlec },
				{ row: selectedRowData, col: 7, value: updatedData.perlecamt },
				{ row: selectedRowData, col: 8, value: updatedData.totalpaid },
				{ row: selectedRowData, col: 9, value: updatedData.balanceamount },
				{ row: selectedRowData, col: 10, value: updatedData.totalpayment },
				{ row: selectedRowData, col: 11, value: updatedData.note }
            ];
            try {
                showLoading();
                const updatesParam = encodeURIComponent(JSON.stringify(updates));
                const response = await fetch(`${scriptURL}?action=updateData&updates=${updatesParam}`);
                const result = await response.json();
                alert(result.message);
                showTab('tableView');
                fetchData();
            } catch (error) {
                alert("Error updating row: " + error.message);
            }
            hideLoading();
        });

        let currentPercentage = 0;
const percentageElement = document.getElementById("loadingPercentage");

function showLoading() {
    loadingOverlay.style.display = "flex";
    updateLoadingPercentage(0); // Reset to 0% when loading starts
}

function hideLoading() {
    loadingOverlay.style.display = "none";
}

function updateLoadingPercentage(percentage) {
    currentPercentage = percentage;
    percentageElement.textContent = `${currentPercentage}%`;
}

// Example usage: Increment the percentage during loading
function simulateLoading() {
    let percentage = 0;
    const interval = setInterval(() => {
        percentage += 10; // Increment by 10%
		
        if (percentage > 100) {
            clearInterval(interval);
            hideLoading();
        } else {
            updateLoadingPercentage(percentage);
        }
    }, 200); // Increment every 200ms
}

// Call simulateLoading() for demo purposes
window.onload = () => {
    showLoading();
    simulateLoading();
};

// Function to search data in the table
        function searchTable() {
            const input = document.getElementById("searchInput").value.toLowerCase();
            const table = document.getElementById("dataTable");
            const rows = table.getElementsByTagName("tr");
            let hasResults = false;

            for (let i = 1; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName("td");
                let match = false;

                for (let j = 0; j < cells.length; j++) {
                    if (cells[j].textContent.toLowerCase().includes(input)) {
                        match = true;
                        break;
                    }
                }

                if (match) {
                    rows[i].style.display = ""; // Show row
                    hasResults = true;
                } else {
                    rows[i].style.display = "none"; // Hide row
                }
            }

            // Show or hide "No results" message
            const noResults = document.getElementById("noResults");
            noResults.style.display = hasResults ? "none" : "block";
        }
		
		// Total Lecture number Function
		 document.getElementById("editTlecture").addEventListener("input", function (e) {
        const value = e.target.value;
        if (value < 1) {
            e.target.value = '';
        }
    });
		document.getElementById("editTPaidLec").addEventListener("input", function (e) {
        const value = e.target.value;
        if (value < 1) {
            e.target.value = '';
        }
    });
	document.getElementById("editPerLecAmt").addEventListener("input", function (e) {
        const value = e.target.value;
        if (value < 1) {
            e.target.value = '';
        }
    });
	
	// Amount automatic Calculation Function
	
	             function calculateValues() {
            const editTlecture = parseFloat(document.getElementById('editTlecture').value) || 0;
            const editTPaidLec = parseFloat(document.getElementById('editTPaidLec').value) || 0;
            const editPerLecAmt = parseFloat(document.getElementById('editPerLecAmt').value) || 0;

            const totalPayment = editTlecture * editPerLecAmt;
            const totalPaid = editTPaidLec * editPerLecAmt;
            const balanceAmount = totalPayment - totalPaid;

            document.getElementById('totalPayment').value = totalPayment.toFixed(2);
            document.getElementById('totalPaid').value = totalPaid.toFixed(2);
            document.getElementById('balanceAmount').value = balanceAmount.toFixed(2);
        }
	      
	
        // Initial data load on page load
        window.onload = fetchData;
    </script>
</body>
</html>
